<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title with Wedding Names -->
    <title>دعوة حفل زفاف فهمي و نور</title>
    <!-- Google Fonts for Arabic font 'Cairo' -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* General Body Styling */
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            /* Theme color as background, but video will cover it */
            background-color: #F7EEDF;
            color: #333; /* Dark gray for text */
            line-height: 1.6;
            direction: rtl; /* Right-to-left for Arabic text */
            text-align: right; /* Align text to the right */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure page takes at least full viewport height */
            position: relative; /* Needed for video background positioning */
            overflow: hidden; /* Hide overflow from video */
        }

        /* Video Background Styling */
        #background-video {
            position: fixed; /* Fix video to viewport */
            top: 0;
            left: 0;
            width: 100vw; /* Explicitly set to full viewport width */
            height: 100vh; /* Explicitly set to full viewport height */
            z-index: -1; /* Place behind other content */
            object-fit: cover; /* Cover the entire container, maintaining aspect ratio */
            /* Optional: Add blur or darken effect for readability */
            filter: brightness(75%) blur(1.5px); /* Slightly reduced blur and brightness */
            transition: filter 0.5s ease; /* Smooth transition for filter changes */
        }

        /* Container Styling */
        .container {
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white for readability over video */
            padding: 30px;
            border-radius: 10px; /* Slightly rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
            max-width: 600px; /* Maximum width of the form */
            width: 90%; /* Responsive width */
            margin: 20px auto; /* Center the container with some vertical margin */
            z-index: 1; /* Ensure it's above the video */
            position: relative; /* For z-index to work correctly */
        }

        /* Header & Imagery Styling */
        .header {
            text-align: center; /* Center header content */
            margin-bottom: 25px;
        }

        .header img {
            max-width: 100%; /* Responsive image */
            height: auto;
            border-radius: 8px; /* Rounded image corners */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Soft shadow for image */
            margin-bottom: 20px;
        }

        h1 {
            color: #8B4513; /* Earthy brown tone for the main title */
            font-size: 2em;
            margin-bottom: 10px;
        }

        p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
        }

        /* Form Element Styling */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block; /* Each label on its own line */
            margin-bottom: 8px;
            font-weight: bold;
            color: #666;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: calc(100% - 20px); /* Full width minus padding for box-sizing */
            padding: 12px;
            border: 1px solid #ddd; /* Light gray border */
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box; /* Include padding in element's total width/height */
            text-align: right; /* Input text aligned to the right */
            background-color: #fefefe; /* Slightly off-white for inputs */
            height: 48px; /* Fixed height for consistent alignment */
            line-height: 24px; /* Adjust line-height for vertical alignment of text within input/select */
        }

        /* Side-by-side fields */
        .field-row {
            display: flex;
            flex-direction: column; /* Default to column for small screens */
            gap: 15px;
            align-items: flex-end; /* Align items to the right for consistent baselines/bottoms */
        }

        .field-row .form-group {
            flex: 1; /* Allow flex items to grow */
            margin-bottom: 0; /* Remove default margin as gap handles spacing */
        }

        /* Specific sizing for name and title fields on larger screens */
        @media (min-width: 600px) {
            .field-row {
                flex-direction: row-reverse; /* Reverse order for Arabic: Title then Name */
                align-items: flex-end; /* Align bottoms of the inputs */
            }
            .field-row .name-group {
                flex: 2; /* Make name field wider (e.g., 2/3 of space) */
            }
            .field-row .title-group {
                flex: 1; /* Make title field smaller (e.g., 1/3 of space) */
            }
        }

        input[type="radio"] {
            margin-left: 10px; /* Space out radio buttons from their labels */
            margin-right: 0; /* Override default left margin */
        }

        .radio-group label {
            display: inline-block; /* Labels next to radio buttons */
            margin-left: 20px;
            font-weight: normal;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end; /* Align radio options to the right */
            gap: 15px; /* Space between radio options */
        }
        .radio-group div {
            display: flex;
            align-items: center;
            gap: 5px; /* Space between radio button and its label */
        }

        button {
            background-color: #8B4513; /* Earthy brown button */
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease; /* Smooth hover effect */
            width: 100%; /* Full width button */
        }

        button:hover {
            background-color: #6B330F; /* Darker brown on hover */
        }

        button:disabled {
            background-color: #ccc; /* Gray out disabled button */
            cursor: not-allowed;
        }

        /* Message Display Styling */
        #responseMessage {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default, shown by JS */
        }

        .success {
            background-color: #d4edda; /* Light green background */
            color: #155724; /* Dark green text */
            border: 1px solid #badbcc; /* Green border */
        }

        .error {
            background-color: #f8d7da; /* Light red background */
            color: #721c24; /* Dark red text */
            border: 1px solid #f5c6cb; /* Red border */
        }

        /* Dynamic Guest Section Styling */
        .guest-section {
            background-color: #f2f2f2; /* Light gray background for guest sections */
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px dashed #ccc; /* Dashed border for visual separation */
        }

        .guest-section h3 {
            color: #8B4513;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #ddd; /* Separator line */
            padding-bottom: 10px;
        }

        /* Custom styling for select arrow (override default) */
        select {
            appearance: none; /* Remove default browser arrow */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            /* Custom SVG arrow, positioned to the left (visual right in RTL) */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23666' d='M8 12.5L3.5 8h9L8 12.5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 10px center; /* Position arrow to the left (right visually in RTL) */
            padding-left: 30px; /* Add padding for the arrow */
            padding-right: 12px; /* Maintain original padding */
        }
    </style>
</head>
<body>
    <!-- Video Background -->
    <!-- Added playsinline for better mobile compatibility (iOS) -->
    <video autoplay muted loop playsinline id="background-video">
        <!-- IMPORTANT: Ensure 'video.mp4' is in the same directory as index.html -->
        <source src="video.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="container">
        <div class="header">
            <!-- IMPORTANT: Ensure 'fahminoor.png' is in the same directory as index.html -->
            <img src="fahminoor.png" alt="صورة الزفاف">
            <!-- Updated Title with Wedding Names -->
            <h1>دعوة حفل زفاف فهمي و نور</h1>
            <p>نتشرف بدعوتكم لمشاركتنا فرحة العمر في حفل زفافنا. يرجى تأكيد حضوركم عن طريق تعبئة النموذج أدناه.</p>
        </div>

        <form id="rsvpForm">
            <!-- Main Invitee Name and Title (side-by-side) -->
            <div class="field-row">
                <div class="form-group title-group">
                    <label for="inviteeTitle">لقبك:</label>
                    <select id="inviteeTitle" name="inviteeTitle" required>
                        <!-- 'disabled selected hidden' makes this option unselectable and serves as a placeholder -->
                        <option value="" disabled selected hidden>اختر لقبك</option>
                        <option value="السيد">السيد</option>
                        <option value="السيدة">السيدة</option>
                    </select>
                </div>
                <div class="form-group name-group">
                    <label for="inviteeName">اسمك الكريم:</label>
                    <input type="text" id="inviteeName" name="inviteeName" required readonly>
                </div>
            </div>

            <!-- RSVP Status (Yes/No) -->
            <div class="form-group">
                <label>هل ستحضرون حفل زفافنا؟</label>
                <div class="radio-group">
                    <div>
                        <input type="radio" id="rsvpYes" name="rsvpStatus" value="نعم، سأحضر" required>
                        <label for="rsvpYes">نعم، سأحضر</label>
                    </div>
                    <div>
                        <input type="radio" id="rsvpNo" name="rsvpStatus" value="لا، لن أحضر">
                        <label for="rsvpNo">لا، لن أحضر</label>
                    </div>
                </div>
            </div>

            <!-- Attending Details Section (shown if RSVP is 'Yes') -->
            <div id="attendingDetails">
                <div class="form-group">
                    <label for="numGuests">كم عدد الضيوف الكليين الذين سيحضرون معكم؟ (بما في ذلك أنت)</label>
                    <!-- Min is 1 (main invitee), max is dynamic based on URL parameter -->
                    <input type="number" id="numGuests" name="numGuests" min="1" value="1" required>
                    <!-- Removed description of max guests -->
                </div>

                <div id="guestsContainer">
                    <!-- Dynamic guest fields will be inserted here by JavaScript -->
                </div>

                <!-- Song Request -->
                <div class="form-group">
                    <label for="songRequest">هل توجد أغنية مفضلة تود سماعها في حفل الزفاف؟</label>
                    <input type="text" id="songRequest" name="songRequest">
                </div>

                <!-- Other Notes -->
                <div class="form-group">
                    <label for="otherNotes">ملاحظات أخرى:</label>
                    <textarea id="otherNotes" name="otherNotes" rows="3"></textarea>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submitButton">إرسال تأكيد الحضور</button>
            <!-- Response Message Area -->
            <div id="responseMessage"></div>
        </form>
    </div>

    <script>
        // IMPORTANT: Your Apps Script Web App URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwslZ-1fazX8eDjsF6TS23heh-REA06Ic8AvdhynkB_HEX2CG37Dv6icznOCRBetNN0/exec';

        // Get references to HTML elements
        const rsvpForm = document.getElementById('rsvpForm');
        const inviteeNameInput = document.getElementById('inviteeName');
        const inviteeTitleSelect = document.getElementById('inviteeTitle');
        const rsvpYes = document.getElementById('rsvpYes');
        const rsvpNo = document.getElementById('rsvpNo');
        const attendingDetails = document.getElementById('attendingDetails');
        const numGuestsInput = document.getElementById('numGuests');
        const guestsContainer = document.getElementById('guestsContainer');
        const submitButton = document.getElementById('submitButton');
        const responseMessage = document.getElementById('responseMessage');

        let maxTotalGuestsAllowed = 1; // This will store the maximum total guests allowed (including invitee), parsed from URL.

        // Function to parse URL query parameters
        function getQueryParams() {
            const params = {};
            window.location.search.substring(1).split('&').forEach(param => {
                const [key, value] = param.split('=');
                params[decodeURIComponent(key)] = decodeURIComponent(value || '');
            });
            return params;
        }

        // Function to initialize the form based on URL parameters
        function initForm() {
            const queryParams = getQueryParams();

            const inviteeName = queryParams.name || '';
            const initialMaxGuests = parseInt(queryParams.max || '1'); // Default to 1 if max is not provided
            const inviteeTitle = queryParams.title || '';

            // Pre-fill invitee name and title
            if (inviteeName) {
                inviteeNameInput.value = inviteeName;
            }
            if (inviteeTitle) {
                inviteeTitleSelect.value = inviteeTitle;
            }

            // Set the dynamic maximum total guests allowed
            maxTotalGuestsAllowed = Math.max(1, initialMaxGuests); // Ensure min is 1
            numGuestsInput.max = maxTotalGuestsAllowed;

            // Automatically set the initial number of guests to the maximum allowed
            numGuestsInput.value = maxTotalGuestsAllowed;

            // Ensure the initial state correctly reflects RSVP choice
            toggleAttendingDetails();
            renderGuestFields(); // Render initial guest fields based on the pre-populated numGuestsInput value
        }

        // Function to dynamically render guest input fields based on `numGuestsInput` value
        function renderGuestFields() {
            const num = parseInt(numGuestsInput.value);
            guestsContainer.innerHTML = ''; // Clear any previously rendered guest fields

            // Client-side validation: ensure the total number of guests is within allowed range
            // 'num' here refers to the total number of people including the main invitee.
            // We need to render fields for num - 1 additional guests.
            if (num < 1 || num > maxTotalGuestsAllowed) {
                responseMessage.textContent = `الرجاء إدخال العدد الكلي للحضور بين 1 و ${maxTotalGuestsAllowed}.`;
                responseMessage.className = 'error';
                responseMessage.style.display = 'block';
                submitButton.disabled = true; // Disable submit if validation fails
                return;
            } else {
                responseMessage.style.display = 'none'; // Hide error message if valid
                submitButton.disabled = false; // Enable submit button
            }

            const numberOfAdditionalGuests = num - 1; // Calculate how many additional guest fields to show

            // Loop to create and append input fields for each *additional* guest
            for (let i = 1; i <= numberOfAdditionalGuests; i++) {
                const guestSection = document.createElement('div');
                guestSection.className = 'guest-section'; // Apply styling for guest sections
                guestSection.innerHTML = `
                    <h3>تفاصيل الضيف ${i}</h3>
                    <div class="field-row">
                        <div class="form-group">
                            <label for="guest${i}Name">الاسم الكامل للضيف ${i}:</label>
                            <input type="text" id="guest${i}Name" name="guest${i}Name" required>
                        </div>
                        <div class="form-group">
                            <label for="guest${i}Title">لقب الضيف ${i}:</label>
                            <select id="guest${i}Title" name="guest${i}Title" required>
                                <option value="" disabled selected hidden>اختر لقبك</option>
                                <option value="السيد">السيد</option>
                                <option value="السيدة">السيدة</option>
                            </select>
                        </div>
                    </div>
                `;
                guestsContainer.appendChild(guestSection);
            }
        }

        // Event listener: Call renderGuestFields whenever the number of guests input changes
        numGuestsInput.addEventListener('input', renderGuestFields);

        // Function to toggle the visibility of the "attending details" section
        function toggleAttendingDetails() {
            if (rsvpYes.checked) {
                attendingDetails.style.display = 'block';
                numGuestsInput.setAttribute('required', 'true'); // Make guest count required if attending
                // When switching from 'No' to 'Yes', reset numGuests to the max allowed by invite
                if (numGuestsInput.value === "0" || parseInt(numGuestsInput.value) < 1) { // Check if value is 0 or less
                     numGuestsInput.value = maxTotalGuestsAllowed;
                }
                renderGuestFields(); // Ensure guest fields are rendered based on current numGuests value
            } else {
                attendingDetails.style.display = 'none';
                numGuestsInput.removeAttribute('required'); // No longer required if not attending
                numGuestsInput.value = 1; // Reset guest count to 1 (main invitee, won't show if section is hidden)
                guestsContainer.innerHTML = ''; // Clear any visible guest fields
            }
        }

        // Event listeners for RSVP status radio buttons
        rsvpYes.addEventListener('change', toggleAttendingDetails);
        rsvpNo.addEventListener('change', toggleAttendingDetails);

        // Initialize form state on page load
        window.addEventListener('load', initForm);

        // Form submission handler
        rsvpForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent the default browser form submission

            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.textContent = 'جاري الإرسال...';
            responseMessage.style.display = 'none'; // Hide previous messages
            responseMessage.className = ''; // Clear previous message styling

            // Collect form data
            const formData = new FormData(rsvpForm);
            const data = {
                inviteeName: formData.get('inviteeName'),
                inviteeTitle: formData.get('inviteeTitle'),
                rsvpStatus: formData.get('rsvpStatus'),
                songRequest: formData.get('songRequest'),
                otherNotes: formData.get('otherNotes'),
                guests: [] // Array to hold guest objects (additional guests only)
            };

            let totalAttending = 0; // Initialize total attending count

            // Process guest details only if the invitee is attending
            if (data.rsvpStatus === 'نعم، سأحضر') {
                totalAttending = parseInt(formData.get('numGuests')); // Total attending is directly from numGuests input
                const numberOfAdditionalGuests = totalAttending - 1; // Number of additional guests

                // Collect details for each active additional guest field
                for (let i = 1; i <= numberOfAdditionalGuests; i++) {
                    const guestName = formData.get(`guest${i}Name`);
                    const guestTitle = formData.get(`guest${i}Title`);

                    // Only add guest if their name is provided (basic validation)
                    if (guestName) {
                        data.guests.push({
                            name: guestName,
                            title: guestTitle
                        });
                    }
                }
            }
            data.totalAttending = totalAttending; // Set total attending in the data object

            try {
                // Send data to Google Apps Script Web App
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Use 'no-cors' for Apps Script Web Apps to avoid CORS issues
                    cache: 'no-cache',
                    credentials: 'omit',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data) // Send collected data as JSON
                });

                // Conditional confirmation messages based on RSVP status
                if (data.rsvpStatus === 'نعم، سأحضر') {
                    responseMessage.textContent = 'يسعدنا جداً حضوركم! تم تأكيد حضوركم بنجاح. نتشوق لرؤيتكم في حفل زفافنا.';
                    responseMessage.className = 'success';
                } else {
                    responseMessage.textContent = 'نأسف لعدم تمكنكم من الحضور. شكراً لتأكيدكم، ونتمنى لكم كل خير.';
                    responseMessage.className = 'error'; /* Using error class for 'no' just for contrasting style */
                }
                responseMessage.style.display = 'block';

                rsvpForm.reset(); // Clear the form fields
                // Re-initialize the form to restore pre-filled name and dynamic limits after reset
                initForm();
            } catch (error) {
                console.error('Error submitting form:', error); // Log detailed error to console
                responseMessage.textContent = 'حدث خطأ أثناء إرسال تأكيد الحضور. يرجى المحاولة مرة أخرى.';
                responseMessage.className = 'error';
                responseMessage.style.display = 'block';
            } finally {
                // Re-enable button and reset text
                submitButton.disabled = false;
                submitButton.textContent = 'إرسال تأكيد الحضور';
            }
        });
    </script>
</body>
</html>
